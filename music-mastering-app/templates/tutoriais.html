{% extends "base.html" %}

{% block title %}Tutoriais - SoundNest{% endblock %}

{% block content %}
<div class="page-container">
    <header class="page-header tutoriais-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1>Tutoriais e dicas de Produção Musical</h1>
            <p>Aprenda técnicas profissionais de produção, mixagem e masterização com os melhores produtores brasileiros</p>
        </div>
    </header>

    <main class="main-content">
        <div class="surface-panel">
            <!-- Tutorials Section -->
            <section class="tutorials-section">
                <div class="tutorials-grid" id="tutorials-container">
                    <!-- Os tutoriais serão carregados aqui -->
                </div>
            </section>

            <!-- Resources Section -->
            <section class="resources-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-book"></i> Recursos Adicionais</h2>
                    <p class="section-subtitle">Complemente seus estudos com materiais exclusivos e recomendações profissionais</p>
                </div>
                
                <div class="resources-grid">
                <div class="card">
                    <div class="card-icon">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <h3>Canais Recomendados</h3>
                    <ul class="resource-list">
                        <li><a href="https://www.youtube.com/@pmmbeats" target="_blank">PMM</a></li>
                        <li><a href="https://www.youtube.com/c/ProduceLikeAPro" target="_blank">Produce Like A Pro</a></li>
                        <li><a href="https://www.youtube.com/c/RecordingRevolution" target="_blank">Recording Revolution</a></li>
                        <li><a href="https://www.youtube.com/c/ADSR" target="_blank">ADSR</a></li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3>Livros Recomendados</h3>
                    <ul class="resource-list">
                        <li>"Mixing Secrets for the Small Studio" - Mike Senior</li>
                        <li>"The Mixing Engineer's Handbook" - Bobby Owsinski</li>
                        <li>"Mastering Audio" - Bob Katz</li>
                        <li>"The Art of Mixing" - David Gibson</li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-laptop"></i>
                    </div>
                    <h3>Software Recomendado</h3>
                    <ul class="resource-list">
                        <li>DAWs: FL Studio, Logic Pro, Pro Tools, Ableton Live</li>
                        <li>Plugins: Waves, FabFilter, iZotope, Vital, Endless Smile</li>
                        <li>Gratuitos: Reaper, Audacity, LMMS</li>
                    </ul>
                </div>
            </div>
            </section>

            {% if not current_user.is_authenticated %}
            <!-- CTA Section -->
            <section class="cta-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-rocket"></i> Quer mais conteúdo?</h2>
                    <p class="section-subtitle">Faça login para acessar tutoriais exclusivos e conteúdo premium</p>
                </div>
                
                <div class="cta-buttons">
                    <a href="{{ url_for('cadastro') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Criar Conta
                    </a>
                    <a href="{{ url_for('login') }}" class="btn btn-secondary">
                        <i class="fas fa-sign-in-alt"></i> Fazer Login
                    </a>
                </div>
            </section>
            {% endif %}
        </div>
    </main>
</div>

<!-- Template para os cards de tutorial -->
<template id="tutorial-template">
    <div class="tutorial-card">
        <div class="tutorial-header">
            <h3 class="tutorial-title"></h3>
            <div class="tutorial-meta">
                <span class="tutorial-channel"></span>
                <span class="tutorial-stats">
                    <i class="fas fa-eye"></i> <span class="view-count"></span>
                    <i class="fas fa-thumbs-up"></i> <span class="like-count"></span>
                </span>
            </div>
        </div>
        <div class="video-thumbnail">
            <img class="thumbnail-img" alt="Thumbnail do vídeo">
            <div class="play-overlay">
                <i class="fab fa-youtube"></i>
            </div>
        </div>
        <div class="tutorial-footer">
            <a href="#" class="btn btn-primary watch-btn" target="_blank">
                <i class="fab fa-youtube"></i> Assistir Tutorial
            </a>
        </div>
    </div>
</template>

<script>
// Função para carregar os tutoriais
async function loadTutorials() {
    try {
        const response = await fetch('/api/youtube-tutorials');
        const data = await response.json();
        
        if (data.success) {
            displayTutorials(data.tutorials, data.is_authenticated);
        } else {
            showError('Erro ao carregar tutoriais: ' + data.error);
        }
    } catch (error) {
        showError('Erro ao conectar com o servidor: ' + error.message);
    }
}

// Função para exibir os tutoriais
function displayTutorials(tutorials, isAuthenticated = false) {
    const container = document.getElementById('tutorials-container');
    const template = document.getElementById('tutorial-template');
    
    // Limpa o container
    container.innerHTML = '';
    
    if (tutorials.length === 0) {
        container.innerHTML = `
            <div class="tutorial-card" style="text-align: center; padding: 3rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--secondary-color); margin-bottom: 1rem;"></i>
                <p>Nenhum tutorial encontrado no momento.</p>
            </div>
        `;
        return;
    }
    

    
    tutorials.forEach(tutorial => {
        const clone = template.content.cloneNode(true);
        
        // Preenche os dados
        clone.querySelector('.tutorial-title').textContent = tutorial.title;
        clone.querySelector('.tutorial-channel').textContent = tutorial.channel;
        clone.querySelector('.view-count').textContent = formatNumber(tutorial.view_count);
        clone.querySelector('.like-count').textContent = formatNumber(tutorial.like_count);
        
        // Configura a thumbnail
        const thumbnailImg = clone.querySelector('.thumbnail-img');
        thumbnailImg.src = tutorial.thumbnail;
        thumbnailImg.alt = tutorial.title;
        
        // Configura o link do YouTube
        const watchBtn = clone.querySelector('.watch-btn');
        watchBtn.href = `https://www.youtube.com/watch?v=${tutorial.id}`;
        
        // Adiciona evento de clique na thumbnail
        const thumbnailContainer = clone.querySelector('.video-thumbnail');
        thumbnailContainer.addEventListener('click', function() {
            // Marcar tutorial como assistido se o usuário estiver logado
            if (isAuthenticated) {
                markTutorialAsWatched(tutorial.id);
            }
            window.open(`https://www.youtube.com/watch?v=${tutorial.id}`, '_blank');
        });
        
        // Adiciona evento de clique no botão de assistir
        const watchBtnElement = clone.querySelector('.watch-btn');
        watchBtnElement.addEventListener('click', function(e) {
            // Marcar tutorial como assistido se o usuário estiver logado
            if (isAuthenticated) {
                markTutorialAsWatched(tutorial.id);
            }
        });
        
        container.appendChild(clone);
    });
}

// Função para marcar tutorial como assistido
function markTutorialAsWatched(tutorialId) {
    fetch('/api/mark-tutorial-watched', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ tutorial_id: tutorialId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Tutorial marcado como assistido:', tutorialId);
        } else {
            console.error('Erro ao marcar tutorial:', data.error);
        }
    })
    .catch(error => {
        console.error('Erro ao marcar tutorial:', error);
    });
}

// Função para formatar números
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Função para mostrar erros
function showError(message) {
    const container = document.getElementById('tutorials-container');
    container.innerHTML = `
        <div class="tutorial-card" style="text-align: center; padding: 3rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--secondary-color); margin-bottom: 1rem;"></i>
            <p>${message}</p>
            <button onclick="loadTutorials()" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="fas fa-redo"></i> Tentar Novamente
            </button>
        </div>
    `;
}

// Carrega os tutoriais quando a página carrega
document.addEventListener('DOMContentLoaded', loadTutorials);
</script>
{% endblock %}
